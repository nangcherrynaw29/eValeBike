image: gradle:8-jdk21

services:
  - docker:20.10.24-dind
  - postgres:17.2-alpine
  #strings are correct syntax fir gitlab

variables:
  POSTGRES_DB: eValeBike
  POSTGRES_USER: user #todo make Gitlab variable
  POSTGRES_PASSWORD: password #todo make Gitlab variable
  SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/eValeBike
  SPRING_DATASOURCE_USERNAME: user #todo make Gitlab variable
  SPRING_DATASOURCE_PASSWORD: password #todo make Gitlab variable
  DOCKER_HOST: tcp://docker:2375  # Required for Docker-in-Docker
  DOCKER_TLS_CERTDIR: "" # tls disabled

stages:
  - build
  - test
  - sast #static application security testing
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."
  - export GRADLE_USER_HOME=`pwd`/.gradle

build_job:
  stage: build
  script:
    - gradle clean build --exclude-task test
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 week


test_job:
  stage: test
  image: gradle:8-jdk21
  services:
    - name: postgres:17.2-alpine
      alias: db  # Makes sure PostgreSQL is reachable at 'db'
  script:
    - echo "Checking if PostgreSQL is ready..."
    - |
      for i in {1..30}; do
        if psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null; then
          echo "PostgreSQL is ready!"
          break
        fi
        echo "Waiting for PostgreSQL (attempt $i/30)..."
        sleep 2
      done
      if [ $i -eq 30 ]; then
        echo "Error: PostgreSQL not ready after 60 seconds"
        exit 1
      fi
    - echo "Running tests..."
    - gradle test --info  # Runs tests with detailed output
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/

# Static Application Security Testing (SAST)
sast_job:
  stage: sast
  image: gradle:8-jdk21
  script:
    #SpotBugs integrated with Gradle
    - gradle spotbugsMain
  artifacts:
    when: always
    paths:
      - build/reports/spotbugs/main.xml
    reports:
      sast: build/reports/spotbugs/main.xml

deploy_job:
  stage: deploy
  when: manual
  script:
    - echo "Deploying manually after approval"
    - ssh user@your-server-ip 'docker stop myapp || true && docker rm myapp || true'
    - ssh user@your-server-ip 'docker pull registry.gitlab.com/kdg-ti/integration-4/2024-2025/team-4/team-4:latest'
    - ssh user@your-server-ip 'docker run -d --name myapp -p 8080:8080 registry.gitlab.com/kdg-ti/integration-4/2024-2025/team-4/team-4:latest'
  only:
    - main

destroy_job:
  stage: destroy
  when: manual
  script:
    - echo "Destroying application manually"
    - ssh user@your-server-ip 'docker stop myapp && docker rm myapp'
  only:
    - main
