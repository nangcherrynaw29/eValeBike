services:
  - docker:20.10.24-dind

include:
  - template: Security/SAST.gitlab-ci.yml

variables:
  DOCKER_HOST: tcp://docker:2375
  DOCKER_TLS_CERTDIR: ""
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEYY
  APP_SERVER: $APP_SERVER
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_REF_SLUG
  DOCKERHUB_USER: $DOCKERHUB_USERNAME
  DOCKERHUB_PASS: $DOCKERHUB_PASSWORD

stages:
  - build
  - test
  - sast
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."

build_job:
  stage: build
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  script:
    - echo "Listing files before build..."
    - ls -la
    - gradle build -x test
    - echo "Listing artifacts after build..."
    - ls -la build.gradle.kts settings.gradle.kts src/ gradle/ gradlew gradlew.bat build/libs/
  artifacts:
    paths:
      - build/libs/*.jar
      - build/libs/
      - build.gradle.kts
      - settings.gradle.kts
      - src/
      - gradle/
      - gradlew
      - gradlew.bat
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Verifying artifacts in working directory..."
    - ls -la build.gradle.kts settings.gradle.kts src/ gradle/ gradlew gradlew.bat || { echo "Artifacts missing"; exit 1; }
    - echo "Creating directory on app server..."
    - ssh team4@$APP_SERVER "mkdir -p /home/team4/evalbike && chmod 755 /home/team4/evalbike" || { echo "Failed to create directory"; exit 1; }
    - echo "Installing Java 21 on app server..."
    - ssh team4@$APP_SERVER 'if command -v dnf >/dev/null 2>&1; then echo "Using dnf to install Java 21..." && sudo dnf install -y java-21-openjdk-devel || { echo "dnf install failed, attempting manual installation..."; }; elif command -v apt >/dev/null 2>&1; then echo "Using apt to install Java 21..." && sudo apt update && sudo apt install -y openjdk-21-jdk || { echo "apt install failed, attempting manual installation..."; }; else echo "No supported package manager found, attempting manual installation..."; fi; if [ ! -x "$(command -v java)" ]; then echo "Java not found, installing manually..." && sudo mkdir -p /usr/lib/jvm && curl -L -o /tmp/openjdk21.tar.gz https://github.com/adoptium/temurin21-binaries/releases/download/jdk-21.0.4%2B7/OpenJDK21U-jdk_x64_linux_hotspot_21.0.4_7.tar.gz && sudo tar -xzf /tmp/openjdk21.tar.gz -C /usr/lib/jvm && rm /tmp/openjdk21.tar.gz && sudo ln -s /usr/lib/jvm/jdk-21.0.4+7 /usr/lib/jvm/java-21-openjdk; fi; echo "Java installation complete, verifying..." && java -version || { echo "Java installation failed"; exit 1; }'
    - echo "Copying project to app server..."
    - scp -r build.gradle.kts settings.gradle.kts src/ gradle/ gradlew gradlew.bat team4@$APP_SERVER:/home/team4/evalbike/ || { echo "Failed to copy project files"; exit 1; }
    - echo "Verifying Java and Gradle on app server..."
    - ssh team4@$APP_SERVER "java -version || { echo 'Java not found'; exit 1; }" || { echo "Java not installed on app server"; exit 1; }
    - ssh team4@$APP_SERVER "/home/team4/evalbike/gradlew -v" || { echo "Gradle wrapper failed"; exit 1; }
    - echo "Running tests on app server..."
    - |
      ssh -tt team4@$APP_SERVER << EOF
        cd /home/team4/evalbike
        export JAVA_HOME=/usr/lib/jvm/java-21-openjdk || export JAVA_HOME=/usr/lib/jvm/jdk-21.0.4+7
        export PATH=\$JAVA_HOME/bin:\$PATH
        java -version || { echo "Java path incorrect"; exit 1; }
        chmod +x gradlew
        ./gradlew clean test --info --stacktrace || { echo "Tests failed"; exit 1; }
        echo "Listing test results..."
        ls -la /home/team4/evalbike/build/test-results/test/ || echo "No test results found"
        exit
      EOF
    - echo "Copying test results back..."
    - mkdir -p build/test-results/test
    - scp -r team4@$APP_SERVER:/home/team4/evalbike/build/test-results/test/*.xml build/test-results/test/ || { echo "Failed to copy test results, checking if files exist..."; ssh team4@$APP_SERVER "ls -la /home/team4/evalbike/build/test-results/test/"; exit 1; }
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/
  needs:
    - build_job

sast:
  stage: sast
  script:
    - echo "Running SAST analysis..."
  artifacts:
    paths:
      - gl-sast-report.json
    expire_in: 1 week
  allow_failure: false

deploy_job:
  stage: deploy
  image: docker:stable
  services:
    - name: docker:20.10.24-dind
      alias: docker
  tags:
    - docker
  before_script:
    - echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "$IMAGE_NAME:$IMAGE_TAG"
    - docker build -t $IMAGE_NAME:$IMAGE_TAG .
    - docker push $IMAGE_NAME:$IMAGE_TAG
    - |
      ssh -tt team4@$APP_SERVER << EOF
        sudo docker stop spring-app || true
        sudo docker rm spring-app || true
        sudo docker pull $IMAGE_NAME:$IMAGE_TAG
        sudo docker run -d --name spring-app -p 80:8080 \
          -e SPRING_DATASOURCE_URL="jdbc:sqlserver://evalebike.database.windows.net:1433;database=eValeBike;user=user@evalebike;password=password!1;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30" \
          -e SPRING_DATASOURCE_USERNAME=user \
          -e SPRING_DATASOURCE_PASSWORD=password!1 \
          $IMAGE_NAME:$IMAGE_TAG
        exit
      EOF

destroy_job:
  stage: destroy
  when: manual
  image: docker:stable
  services:
    - name: docker:20.10.24-dind
      alias: docker
  tags:
    - docker
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Stopping and removing the container..."
    - |
      ssh -tt team4@$APP_SERVER << EOF
        sudo docker stop spring-app || true
        sudo docker rm spring-app || true
        exit
      EOF