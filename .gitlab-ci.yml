build_job:
  stage: build
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  script:
    - gradle build -x test
  artifacts:
    paths:
      - build/libs/*.jar
      - build/libs/
      - build.gradle
      - settings.gradle
      - src/
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8.4.0-jdk21
  tags:
    - docker
    - gradle
    - java
  before_script:
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEYY" | base64 -d > ~/.ssh/gitlabrunner
    - chmod 600 ~/.ssh/gitlabrunner
    - eval "$(ssh-agent -s)"
    - ssh-add ~/.ssh/gitlabrunner
    - ssh-keyscan -H $APP_SERVER >> ~/.ssh/known_hosts
  script:
    - echo "Creating directory on app server..."
    - ssh team4@$APP_SERVER "mkdir -p /home/team4/evalbike"
    - echo "Copying project to app server..."
    - scp -r build.gradle settings.gradle src/ team4@$APP_SERVER:/home/team4/evalbike/ || { echo "Failed to copy project files"; exit 1; }
    - echo "Running tests on app server..."
    - |
      ssh -tt team4@$APP_SERVER << EOF
        cd /home/team4/evalbike
        export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
        export PATH=\$JAVA_HOME/bin:\$PATH
        export SPRING_DATASOURCE_URL="jdbc:sqlserver://evalebike.database.windows.net:1433;database=eValeBikeTest;user=user@evalebike;password=password!1;encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30"
        export SPRING_DATASOURCE_USERNAME=user
        export SPRING_DATASOURCE_PASSWORD=password!1
        gradle test --info || { echo "Tests failed"; exit 1; }
        exit
      EOF
    - echo "Copying test results back..."
    - scp -r team4@$APP_SERVER:/home/team4/evalbike/build/test-results/test/ build/test-results/test/ || { echo "Failed to copy test results"; exit 1; }
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/
  needs:
    - build_job