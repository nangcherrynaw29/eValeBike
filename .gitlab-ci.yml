image: gradle:8-jdk21

#services:
#  - docker:20.10.24-dind
#  - postgres:17.2-alpine
  #strings are correct syntax fir gitlab

include:
  - template: Security/SAST.gitlab-ci.yml

variables:
  POSTGRES_DB: eValeBike
  POSTGRES_USER: user #todo make Gitlab variable
  POSTGRES_PASSWORD: password #todo make Gitlab variable
  SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/eValeBike
  SPRING_DATASOURCE_USERNAME: user #todo make Gitlab variable
  SPRING_DATASOURCE_PASSWORD: password #todo make Gitlab variable
  DOCKER_HOST: tcp://docker:2375  #for docker in docker
  DOCKER_TLS_CERTDIR: "" # tls disabled
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEYY
  APP_SERVER: $APP_SERVER
  IMAGE_NAME: $CI_REGISTRY_IMAGE
  IMAGE_TAG: $CI_COMMIT_REF_SLUG


stages:
  - build
  - test
  - sast #static application security testing
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."
#  - export GRADLE_USER_HOME=`pwd`/.gradle

build_job:
  stage: build
  image: gradle:8-jdk21
  tags:
    - docker
    - gradle
    - java
  script:
    - gradle clean build --exclude-task test
  artifacts:
    paths:
      - build/libs/*.jar
#      - build/libs/
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8-jdk21
  tags:
    - docker
    - gradle
    - java
  services:
    - name: docker:20.10.24-dind
      alias: docker  # Matches DOCKER_HOST
    - name: postgres:17.2-alpine
      alias: db  # Keep for non-Testcontainers tests
  before_script:
    - echo "Installing Docker client..."
    - apt-get update && apt-get install -y docker.io || echo "Docker install failed, continuing..."
  script:
    - echo "Checking Docker service..."
    - docker info || echo "Docker info failed, continuing..."
    - echo "Checking PostgreSQL connectivity..."
    - ping -c 4 db || echo "Ping to db failed, continuing..."
    - echo "Checking PostgreSQL service..."
    - psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null && echo "PostgreSQL is ready!" || echo "PostgreSQL check failed, continuing..."
    - echo "Running tests..."
    - gradle test --info
    - echo "Listing test results directory..."
    - ls -la build/test-results/test/
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/
  needs:
    - build

sast:
  stage: sast
  script:
    - echo "Running SAST analysis..."
  artifacts:
    paths:
      - gl-sast-report.json
    expire_in: 1 week
  allow_failure: false

#destroy_job:
#  stage: destroy
#  when: manual
#  script:
#    - echo "Destroying application manually"
#    - ssh user@your-server-ip 'docker stop myapp && docker rm myapp'
#  only:
#    - main

# Deploy job added
deploy_job:
  stage: deploy
  image: docker:stable
  services:
    - name: docker:dind
      alias:  docker
  variables:
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
    DOCKERHUB_USER: $DOCKERHUB_USERNAME
    DOCKERHUB_PASS: $DOCKERHUB_PASSWORD
  tags:
    - docker
  before_script:
    - |
      echo "$DOCKERHUB_PASS" | docker login -u "$DOCKERHUB_USER" --password-stdin
    #decode private ssh key
    - |
      mkdir -p ~/.ssh
      echo "$SSH_PRIVATE_KEY" | base64 -d > ~/.ssh/gitlabrunner
      chmod 600 ~/.ssh/gitlabrunner
      eval "$(ssh-agent -s)"
      ssh-add ~/.ssh/gitlabrunner
      ssh-keyscan -H $APP_SERVER >> ~/ssh/known_host

  script:
    - echo "Starting remote deploy..."
    - |
      docker build -t $IMAGE_NAME:$IMAGE_TAG .
      docker push $IMAGE_NAME:$IMAGE_TAG
      ssh team4@$APP_SERVER "docker pull $IMAGE_NAME:$IMAGE_TAG && docker stop spring-app || true && docker rm spring-app || true"
      ssh team4@$APP_SERVER "docker run -d --name spring-app -p 80:8080 $IMAGE_NAME:$IMAGE_TAG"
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      needs:
        - test











