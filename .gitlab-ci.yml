image: gradle:8-jdk21

services:
  - docker:20.10.24-dind
  - postgres:17.2-alpine
  #strings are correct syntax fir gitlab

include:
  - template: Security/SAST.gitlab-ci.yml

variables:
  POSTGRES_DB: eValeBike
  POSTGRES_USER: user #todo make Gitlab variable
  POSTGRES_PASSWORD: password #todo make Gitlab variable
  SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/eValeBike
  SPRING_DATASOURCE_USERNAME: user #todo make Gitlab variable
  SPRING_DATASOURCE_PASSWORD: password #todo make Gitlab variable
  DOCKER_HOST: tcp://docker:2375  # Required for Docker-in-Docker
  DOCKER_TLS_CERTDIR: "" # tls disabled
  SERVER_DEPLOY_PATH: /opt/evalebike
  SSH_PRIVATE_KEY: $SSH_PRIVATE_KEY
  SSH_KNOWN_HOSTS: $SSH_KNOWN_HOSTS

stages:
  - build
  - test
  - sast #static application security testing
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."
  - export GRADLE_USER_HOME=`pwd`/.gradle

build_job:
  stage: build
  script:
    - gradle clean build --exclude-task test
  artifacts:
    paths:
      - build/libs/*.jar
      - build/libs/
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8-jdk21
  services:
    - name: docker:20.10.24-dind
      alias: docker  # Matches DOCKER_HOST
    - name: postgres:17.2-alpine
      alias: db  # Keep for non-Testcontainers tests
  before_script:
    - echo "Installing Docker client..."
    - apt-get update && apt-get install -y docker.io || echo "Docker install failed, continuing..."
  script:
    - echo "Checking Docker service..."
    - docker info || echo "Docker info failed, continuing..."
    - echo "Checking PostgreSQL connectivity..."
    - ping -c 4 db || echo "Ping to db failed, continuing..."
    - echo "Checking PostgreSQL service..."
    - psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null && echo "PostgreSQL is ready!" || echo "PostgreSQL check failed, continuing..."
    - echo "Running tests..."
    - gradle test --info
    - echo "Listing test results directory..."
    - ls -la build/test-results/test/
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/

sast:
  stage: sast
  script:
    - echo "Running SAST analysis..."
  artifacts:
    paths:
      - gl-sast-report.json
    expire_in: 1 week
  allow_failure: false

#destroy_job:
#  stage: destroy
#  when: manual
#  script:
#    - echo "Destroying application manually"
#    - ssh user@your-server-ip 'docker stop myapp && docker rm myapp'
#  only:
#    - main

# Deploy job added
deploy_job:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache openssh-client git bash
    - mkdir -p ~/.ssh
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - echo "$SSH_KNOWN_HOSTS" > ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
  script:
    - echo "starting remote deploymnet via ssh"
    - ssh team4@4.180.13.98 'bash -s' < scripts/deploy.sh






