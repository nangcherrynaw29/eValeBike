image: gradle:8-jdk21

services:
  - docker:20.10.24-dind
  - postgres:17.2-alpine
  #strings are correct syntax fir gitlab

variables:
  POSTGRES_DB: eValeBike
  POSTGRES_USER: user #todo make Gitlab variable
  POSTGRES_PASSWORD: password #todo make Gitlab variable
  SPRING_DATASOURCE_URL: jdbc:postgresql://db:5432/eValeBike
  SPRING_DATASOURCE_USERNAME: user #todo make Gitlab variable
  SPRING_DATASOURCE_PASSWORD: password #todo make Gitlab variable
  DOCKER_HOST: tcp://docker:2375  # Required for Docker-in-Docker
  DOCKER_TLS_CERTDIR: "" # tls disabled

stages:
  - build
  - test
  - sast #static application security testing
  - deploy
  - destroy

before_script:
  - echo "Starting CI/CD pipeline..."
  - export GRADLE_USER_HOME=`pwd`/.gradle

build_job:
  stage: build
  script:
    - gradle clean build --exclude-task test
  artifacts:
    paths:
      - build/libs/*.jar
    expire_in: 1 week

test_job:
  stage: test
  image: gradle:8-jdk21
  services:
    - name: docker:20.10.24-dind
      alias: docker  # Matches DOCKER_HOST
    - name: postgres:17.2-alpine
      alias: db  # Keep for non-Testcontainers tests
  before_script:
    - echo "Installing Docker client..."
    - apt-get update && apt-get install -y docker.io || echo "Docker install failed, continuing..."
  script:
    - echo "Checking Docker service..."
    - docker info || echo "Docker info failed, continuing..."
    - echo "Checking PostgreSQL connectivity..."
    - ping -c 4 db || echo "Ping to db failed, continuing..."
    - echo "Checking PostgreSQL service..."
    - psql -h db -U $POSTGRES_USER -d $POSTGRES_DB -c '\q' 2>/dev/null && echo "PostgreSQL is ready!" || echo "PostgreSQL check failed, continuing..."
    - echo "Running tests..."
    - gradle test --info
    - echo "Listing test results directory..."
    - ls -la build/test-results/test/
  artifacts:
    when: always
    reports:
      junit: build/test-results/test/TEST-*.xml
    paths:
      - build/test-results/test/

sast_job:
  stage: sast
  image: gradle:8-jdk21
  dependencies:
    - build_job
  before_script:
    - echo "Checking current working directory..."
    - pwd
    - echo "Checking for build_job artifacts..."
    - ls -la build/libs/ || echo "No JAR files found"
    - echo "Setting up OWASP Dependency-Check..."
    - if [ ! -d "dependency-check" ]; then apt-get update && apt-get install -y wget unzip && wget https://github.com/jeremylong/DependencyCheck/releases/download/v9.0.9/dependency-check-9.0.9-release.zip && unzip dependency-check-9.0.9-release.zip; fi
    - chmod +x dependency-check/bin/dependency-check.sh
  script:
    - echo "Creating output directory..."
    - export OUTPUT_DIR="$(pwd)/build/reports/dependency-check"
    - mkdir -p "$OUTPUT_DIR"
    - chmod -R 777 "$OUTPUT_DIR"
    - chown -R $(whoami) "$OUTPUT_DIR"
    - echo "Verifying output directory..."
    - ls -ld "$OUTPUT_DIR"
    - '[ -z "$NVD_API_KEY" ] && { echo "ERROR: NVD_API_KEY is not set. Please set it in GitLab CI/CD variables."; exit 1; }'
    - echo "NVD_API_KEY is set (masked)"
    - echo "Running OWASP Dependency-Check SAST analysis..."
    - ./dependency-check/bin/dependency-check.sh \
      --project "eValeBike" \
      --scan "build/libs" \
      --format XML \
      --out "$OUTPUT_DIR" \
      --failOnCVSS 0 \
      --nvdApiKey "$NVD_API_KEY" || { echo "Dependency-Check failed"; exit 1; }
    - echo "Checking output directory contents recursively:"
    - find "$OUTPUT_DIR"
    - echo "Dependency-Check log output:"
    - cat sast.log || echo "No sast.log file found"
  artifacts:
    when: always
    paths:
      - build/reports/dependency-check/
      - sast.log
    reports:
      sast: build/reports/dependency-check/dependency-check-report.xml
    expire_in: 1 week
  cache:
    key: dependency-check-cache
    paths:
      - dependency-check/
    policy: pull-push
  needs:
    - build_job
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  timeout: 10m

destroy_job:
  stage: destroy
  when: manual
  script:
    - echo "Destroying application manually"
    - ssh user@your-server-ip 'docker stop myapp && docker rm myapp'
  only:
    - main
